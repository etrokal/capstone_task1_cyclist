---
title: "cyclist_market_analisys_report"
author: "Marcelo Duarte da Silva"
date: "04/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(skimr)
library(janitor)

```

## Introduction

This report contains the market analysis of the customers of **Cyclist** ride share company. This company is fictitious, and this report is part of the capstone project of the Google Data Analytics Professional Certificate. 

## Business Task

This report explores the differences in bike use between annual members a casual riders of the **Cyclist** bike sharing app.

## Objectives

- Compare bike use behavior between annual members and casual riders, in order to identify trends.
- Compare socioeconomic metrics of the customers, in order to better understand 
the differences in behavior of the two groups, if they exist.

## Preparing the data

The analysis used data from **Divvy Bikes** as proxy data. **Divvy Bikes** is a bike sharing company from Chicago and their data is licensed as [public domain](https://www.divvybikes.com/data-license-agreement).

The data used comprise customer data from 2013 up to June/2021.

### Datasets

The datasets were obtained from [this download page](https://divvy-tripdata.s3.amazonaws.com/index.html), in 2021-08-4. The raw data is comprised of of 33 datasets available for download as of the date mentioned.

The first step in our data preparation is to combine these datasets in a single dataset with all the data.



``` {r, include=FALSE}
# loading each dataset before combining them all in one

load_and_clean_1 <- function(path) {
  result <- readr::read_csv(
    path,
    col_types = list(
      ride_id = col_character(),
      rideable_type = col_character(),
      started_at = col_datetime(),
      ended_at = col_datetime(),
      start_station_name = col_character(),
      start_station_id = col_character(),
      end_station_name = col_character(),
      end_station_id = col_character(),
      start_lat = col_double(),
      start_lng = col_double(),
      end_lat = col_double(),
      end_lng = col_double(),
      member_casual = col_character()
    )
  ) %>% 
    janitor::clean_names() %>% 
    janitor::remove_empty()
  
  result$rideable_type = factor(result$rideable_type)
  result$member_casual = factor(result$member_casual)
  
  return(result)
}

##################
#                #
# data from 2021 #
#                #
##################
df_202106 <- load_and_clean_1("./raw_data/202106-divvy-tripdata/202106-divvy-tripdata.csv")

final_df <- df_202106
rm(df_202106)

df_202105 <- load_and_clean_1("./raw_data/202105-divvy-tripdata/202105-divvy-tripdata.csv") 

final_df <- bind_rows(final_df, df_202105)
rm(df_202105)

df_202104 <- load_and_clean_1("./raw_data/202104-divvy-tripdata/202104-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202104)
rm(df_202104)

df_202103 <- load_and_clean_1("./raw_data/202103-divvy-tripdata/202103-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202103)
rm(df_202103)

df_202102 <- load_and_clean_1("./raw_data/202102-divvy-tripdata/202102-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202102)
rm(df_202102)

df_202101 <- load_and_clean_1("./raw_data/202101-divvy-tripdata/202101-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202101)
rm(df_202101)

gc() # reclaiming some unused memory

##################
#                #
# data from 2020 #
#                #
##################
df_202012 <- load_and_clean_1("./raw_data/202012-divvy-tripdata/202012-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202012)
rm(df_202012)

df_202011 <- load_and_clean_1("./raw_data/202011-divvy-tripdata/202011-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202011)
rm(df_202011)

df_202010 <- load_and_clean_1("./raw_data/202010-divvy-tripdata/202010-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202010)
rm(df_202010)

df_202009 <- load_and_clean_1("./raw_data/202009-divvy-tripdata/202009-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202009)
rm(df_202009)

df_202008 <- load_and_clean_1("./raw_data/202008-divvy-tripdata/202008-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202008)
rm(df_202008)

df_202007 <- load_and_clean_1("./raw_data/202007-divvy-tripdata/202007-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202007)
rm(df_202007)

df_202006 <- load_and_clean_1("./raw_data/202006-divvy-tripdata/202006-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202006)
rm(df_202006)

df_202005 <- load_and_clean_1("./raw_data/202005-divvy-tripdata/202005-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202005)
rm(df_202005)

df_202004 <- load_and_clean_1("./raw_data/202004-divvy-tripdata/202004-divvy-tripdata.csv")

final_df <- bind_rows(final_df, df_202004)
rm(df_202004)

df_2020Q1 <- load_and_clean_1("./raw_data/Divvy_Trips_2020_Q1/Divvy_Trips_2020_Q1.csv")

final_df <- bind_rows(final_df, df_2020Q1)
rm(df_2020Q1)


gc() # reclaiming some unused memory


##################
#                #
# data from 2019 #
#                #
##################

load_and_clean_2 <- function(path) {
  result <- readr::read_csv(
    path,
    col_types = list(
      trip_id = col_character(),
      start_time = col_datetime(),
      end_time = col_datetime(),
      bikeid = col_number(),
      tripduration = col_number(),
      from_station_name = col_character(),
      from_station_id = col_character(),
      to_station_name = col_character(),
      to_station_id = col_character(),
      usertype = col_character(),
      gender = col_character(),
      birthyear = col_number()
    )
  ) %>% 
    janitor::clean_names() %>% 
    janitor::remove_empty()
  
  # change the column names to match the more recent ones
  result$ride_id = result$trip_id
  result$started_at = result$start_time
  result$ended_at = result$end_time
  result$start_station_name = result$from_station_name
  result$start_station_id = result$from_station_id
  result$end_station_name = result$to_station_name
  result$end_station_id = result$to_station_id
  
  result <- mutate(
    result, 
    member_casual = if_else(
      usertype == "Subscriber", 
      "member",
      if_else(
        usertype == "Customer",
        "casual",
        NULL
      )
    )
  )
  
  
  # Remove unused or redundant columns
  result <- select(
    result, 
    -trip_id, 
    -tripduration,
    -start_time,
    -end_time,
    -bikeid,
    -usertype,
    -gender,
    -birthyear,
    -from_station_name,
    -from_station_id,
    -to_station_name,
    -to_station_id
  )
  
  return(result)
}

df_2019Q4 <- load_and_clean_2("./raw_data/Divvy_Trips_2019_Q4/Divvy_Trips_2019_Q4.csv")

final_df <- bind_rows(final_df, df_2019Q4)
rm(df_2019Q4)

df_2019Q3 <- load_and_clean_2("./raw_data/Divvy_Trips_2019_Q3/Divvy_Trips_2019_Q3.csv")

final_df <- bind_rows(final_df, df_2019Q3)
rm(df_2019Q3)

gc()

# 2019 Q2 has different column names
load_and_clean_2019Q2 <- function(path) {
  result <- read_csv(
    path,
    skip = 1,
    col_names = c(
      "trip_id",
      "start_time",
      "end_time",
      "bikeid",
      "tripduration",
      "from_station_id",
      "from_station_name",
      "to_station_id",
      "to_station_name",
      "usertype",
      "gender",
      "birthyear"
    ),
    col_types = list(
      trip_id = col_character(),
      start_time = col_datetime(),
      end_time = col_datetime(),
      bikeid = col_number(),
      tripduration = col_number(),
      from_station_name = col_character(),
      from_station_id = col_character(),
      to_station_name = col_character(),
      to_station_id = col_character(),
      usertype = col_character(),
      gender = col_character(),
      birthyear = col_number()
    )
  ) %>% 
    janitor::clean_names() %>% 
    janitor::remove_empty()
  
  # change the column names to match the more recent ones
  result$ride_id = result$trip_id
  result$started_at = result$start_time
  result$ended_at = result$end_time
  result$start_station_name = result$from_station_name
  result$start_station_id = result$from_station_id
  result$end_station_name = result$to_station_name
  result$end_station_id = result$to_station_id
  
  mutate(
    result, 
    member_casual = if_else(
      usertype == "Subscriber", 
      "member",
      if_else(
        usertype == "Customer",
        "casual",
        NULL
      )
    )
  )
  
  
  # Remove unused or redundant columns
  result <- select(
    result, 
    -trip_id, 
    -tripduration,
    -start_time,
    -end_time,
    -bikeid,
    -usertype,
    -gender,
    -birthyear,
    -from_station_name,
    -from_station_id,
    -to_station_name,
    -to_station_id
  )
  
  return(result)
}

df_2019Q2 <- load_and_clean_2019Q2("./raw_data/Divvy_Trips_2019_Q2/Divvy_Trips_2019_Q2.csv")

final_df <- bind_rows(final_df, df_2019Q2)
rm(df_2019Q2)

df_2019Q1 <- load_and_clean_2("./raw_data/Divvy_Trips_2019_Q1/Divvy_Trips_2019_Q1.csv")

final_df <- bind_rows(final_df, df_2019Q1)
rm(df_2019Q1)


#View(final_df)
 

#skimr::skim(df_202105)
#glimpse(df_202105)
#View(df_202105)

# combining the datasets in a single one, and saving to disk
# from here on we will use this combined dataset


glimpse(final_df)

```

## Analysis

How many rides per day?

What is the average ride length (include by year comparision) ? Whats is the average length in the morning, in the afternoon and at night? What about per rideable_type?


What is the most common time of the day for rides, morning, afternoon or night? What about the rideable_type

